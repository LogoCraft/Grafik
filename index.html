<!DOCTYPE html>
<html lang="tr" id="html-tag">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GrafLife</title>

  <!-- Logo -->
  <link rel="icon" type="image/jpeg" href="logo.jpg">
  <link rel="apple-touch-icon" href="logo.jpg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="GrafLife">

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    .font-inter { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #chart-area { position: relative; }
    #metric-chart { width: 100% !important; height: 100% !important; }

    /* --- Hareketli Arka Plan (HERKES Ä°Ã‡Ä°N) --- */
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* GÃ¼ndÃ¼z Modu Arka PlanÄ± */
    body.animated-bg {
      background: linear-gradient(-45deg, #FFFFFF, #F0FDF4, #DCFCE7, #BBF7D0); /* Beyaz -> AÃ§Ä±k YeÅŸil TonlarÄ± */
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    /* Gece Modu Arka PlanÄ± */
    body.dark.animated-bg {
      background: linear-gradient(-45deg, #0c0a09, #1c1917, #064e3b, #14532d); /* Siyah -> Koyu YeÅŸil TonlarÄ± */
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }

    /* --- YENÄ°: YumuÅŸak GeÃ§iÅŸ Animasyonu --- */
    .fade-in-up {
        animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(15px) scale(0.98); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .app-logo { height: 40px; width: auto; object-fit: contain; border-radius: 8px; }
  </style>
  
  <script>
    tailwind.config = {
      darkMode: 'class', 
      theme: {
        extend: {
          colors: {
            'brand-cream': '#FFFFFF',        
            'brand-cream-dark': '#F3F4F6', 
            'brand-green': '#059669',      
            'brand-green-dark': '#047857', 
            'brand-green-light': '#34D399',
            'brand-text': '#292524',      
            'brand-text-secondary': '#57534E', 
          }
        }
      }
    }
  </script>
</head>

<!-- VarsayÄ±lan olarak hareketli arka plan (animated-bg) sÄ±nÄ±fÄ± eklendi -->
<body class="font-inter animated-bg transition-colors duration-500" onload="lucide.createIcons()">

<div id="app-root"></div>

<!-- Genel Modal -->
<div id="custom-modal-backdrop" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 transition-opacity duration-300">
    <div id="custom-modal" class="bg-white dark:bg-stone-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-stone-700">
        <h3 id="modal-title" class="text-2xl font-bold mb-4 text-brand-text dark:text-white"></h3>
        <div id="modal-content" class="text-brand-text-secondary dark:text-stone-300 mb-6 break-words"></div>
        <div id="modal-actions" class="flex flex-col sm:flex-row justify-end sm:space-x-3 space-y-2 sm:space-y-0">
            <button id="modal-cancel-btn" class="px-5 py-2.5 bg-gray-200 dark:bg-stone-700 text-gray-800 dark:text-white font-medium rounded-lg hover:bg-gray-300 transition">Ä°ptal</button>
            <button id="modal-confirm-btn" class="px-5 py-2.5 bg-brand-green text-white font-medium rounded-lg hover:bg-brand-green-dark transition shadow-lg shadow-green-500/30">Onayla</button>
        </div>
    </div>
</div>

<script>
/* --- Sabitler --- */
const CHART_OPTIONS_BASE = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
const ADMIN_EMAIL = 'elaymemmedli27@gmail.com';
const ADMIN_PASSWORD = 'Elsever1975';
const BANNED_EMAIL_EXAMPLE = 'akanak@gmail.com'; 
const FREE_TIER_LIMIT = 15; 

/* --- Dil AyarlarÄ± --- */
let currentLang = localStorage.getItem('lang') || 'tr';
document.getElementById('html-tag').lang = currentLang;

const i18n = {
  tr: {
    "loginTitle": "GrafLife'a HoÅŸ Geldiniz",
    "loginButton": "GiriÅŸ Yap",
    "registerButton": "KayÄ±t Ol ve BaÅŸla",
    "registerNow": "KayÄ±t Ol",
    "noAccount": "HesabÄ±n yok mu?",
    "emailPlaceholder": "Email Adresiniz",
    "passwordPlaceholder": "Åžifreniz",
    "termsLabel": "KullanÄ±m ÅžartlarÄ±nÄ± ve KurallarÄ± kabul ediyorum.",
    "termsError": "GiriÅŸ yapmak iÃ§in kurallarÄ± kabul etmelisiniz.",
    "rulesTitle": "Kurallar",
    "rulesContent": "1. Ä°zinsiz veri kopyalamak yasaktÄ±r.<br>2. Sistem gÃ¼venliÄŸini tehdit etmek yasaktÄ±r.<br>3. Sahte bilgilerle iÅŸlem yapmak yasaktÄ±r.<br>4. HesabÄ±nÄ±zÄ±n gÃ¼venliÄŸinden siz sorumlusunuz.",
    "fakeMailWarningTitle": "SAHTE MAIL UYARISI",
    "fakeMailWarningBody": "GeÃ§ersiz mailler (Ã¶r: ksjdjal@gmail.com) yasaklanacaktÄ±r.",
    "dashboardTitle": "GrafLife",
    "dailyEntryTitle": "Veri GiriÅŸi",
    "dmCountLabel": "DM SayÄ±sÄ±",
    "adSpendLabel": "Reklam ($)",
    "salesCountLabel": "SatÄ±ÅŸ Adedi",
    "revenueLabel": "Gelir ($)",
    "saveMetricsButton": "Kaydet",
    "orders": "SipariÅŸler",
    "notes": "NotlarÄ±m",
    "managementPanel": "YÃ¶netim",
    "upgradeSubscription": "Abonelik",
    "visualizationTitle": "Grafik",
    "recordsTitle": "KayÄ±tlar",
    "colTimestamp": "Tarih",
    "colDM": "DM",
    "colAdSpend": "Reklam",
    "colSales": "SatÄ±ÅŸ",
    "colRevenue": "Gelir",
    "colNetProfit": "KÃ¢r",
    "colActions": "Ä°ÅŸlem",
    "delete": "Sil",
    "subModalTitle": "Abonelik Paketleri",
    "subPrice1": "1 AylÄ±k: ${price}",
    "subPrice3": "3 AylÄ±k: ${price}",
    "subPrice12": "1 YÄ±llÄ±k: ${price}",
    "subAdminEdit": "FiyatlarÄ± DÃ¼zenle (Admin)",
    "notesTitle": "Not Defteri",
    "addNote": "Yeni Not Ekle",
    "noteTitlePh": "BaÅŸlÄ±k...",
    "noteBodyPh": "Ä°Ã§erik...",
    "noteFile": "Dosya/FotoÄŸraf SeÃ§",
    "noteDate": "HatÄ±rlatÄ±cÄ± Tarihi",
    "saveNote": "Notu Kaydet",
    "ordersTitle": "SipariÅŸ Takibi",
    "orderName": "MÃ¼ÅŸteri AdÄ±",
    "orderReq": "Ä°stek",
    "orderAmt": "Tutar",
    "orderNote": "Not",
    "orderReason": "Sebep",
    "orderDate": "Teslim Tarihi / HatÄ±rlatÄ±cÄ±",
    "saveOrder": "SipariÅŸ Ekle",
    "addToMetrics": "Metriklere Ekle",
    "addToMetricsConfirm": "Bu sipariÅŸi (${amount}$) gelir olarak ana tabloya eklemek istiyor musunuz?",
    "alertExpired": "SÃ¼resi Dolan HatÄ±rlatÄ±cÄ±lar Var!",
    "alertExpiredBody": "AÅŸaÄŸÄ±daki kayÄ±tlarÄ±n sÃ¼resi doldu:",
    "extendTime": "SÃ¼reyi Uzat",
    "dismiss": "Tamam",
    "viewCredentials": "Hesap Bilgileri",
    "accountSwitch": "Hesap Ekle & HÄ±zlÄ± GeÃ§iÅŸ",
    "logout": "Ã‡Ä±kÄ±ÅŸ Yap",
    "language": "Dil",
    "theme": "Tema",
    "accountInfoTitle": "Hesap Bilgileri",
    "accountInfoBody": "<p><strong>Email:</strong> {email}</p><p><strong>Åžifre:</strong> {password}</p><p><strong>Abonelik:</strong> <span class='{subClass} font-bold'>{subText}</span></p>",
    "subFree": "Ãœcretsiz",
    "subDiamond": "Elmas",
    "noDataYet": "HenÃ¼z veri yok.",
    "noRecordsFound": "KayÄ±t bulunamadÄ±.",
    "errorFreeLimitTitle": "Limit Doldu",
    "errorFreeLimitBody": "Ãœcretsiz planda maksimum {limit} kayÄ±t ekleyebilirsiniz. LÃ¼tfen abone olun.",
    "switchAccountLabel": "HÄ±zlÄ± GeÃ§iÅŸ YapÄ±lacak Hesaplar:",
    "deleteFromList": "Listeden KaldÄ±r",
    "quickLoginDeleteTitle": "HÄ±zlÄ± GiriÅŸten Sil",
    "quickLoginDeleteBody": "Bu hesabÄ± hÄ±zlÄ± giriÅŸ listesinden kaldÄ±rmak istediÄŸinize emin misiniz?",
    "deleteRecordTitle": "KaydÄ± Sil",
    "deleteRecordBody": "Bu metrik kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?",
    "errorMinOneMetric": "En az bir deÄŸer girmelisiniz.",
    "errorNegativeMetrics": "DeÄŸerler negatif olamaz.",
    "adminPriceSettings": "Abonelik Fiyat AyarlarÄ±",
    "adminPriceSave": "FiyatlarÄ± Kaydet",
    "adminPriceSaved": "Fiyatlar baÅŸarÄ±yla gÃ¼ncellendi!",
    "userRoleAdmin": "YÃ¶netici",
    "userRoleUser": "KullanÄ±cÄ±",
    "actionMakeAdmin": "YÃ¶netici Yap",
    "actionRemoveAdmin": "YÃ¶neticiliÄŸi Al",
    "confirmMakeAdmin": "Bu kullanÄ±cÄ±ya TAM YÃ–NETÄ°CÄ° yetkisi vermek istediÄŸinize emin misiniz?",
    "confirmRemoveAdmin": "Bu kullanÄ±cÄ±nÄ±n yÃ¶netici yetkisini almak istediÄŸinize emin misiniz?",
  },
  en: {
    "loginTitle": "Welcome to GrafLife",
    "loginButton": "Login",
    "registerButton": "Register",
    "registerNow": "Register",
    "noAccount": "No account?",
    "emailPlaceholder": "Email",
    "passwordPlaceholder": "Password",
    "termsLabel": "I accept Terms & Rules.",
    "termsError": "You must accept rules.",
    "rulesTitle": "Rules",
    "rulesContent": "1. No copying.<br>2. No security threats.<br>3. No fake data.<br>4. Account security is yours.",
    "fakeMailWarningTitle": "FAKE MAIL WARNING",
    "fakeMailWarningBody": "Invalid emails will be banned.",
    "dashboardTitle": "GrafLife",
    "dailyEntryTitle": "Data Entry",
    "dmCountLabel": "DM Count",
    "adSpendLabel": "Ad Spend ($)",
    "salesCountLabel": "Sales Count",
    "revenueLabel": "Revenue ($)",
    "saveMetricsButton": "Save",
    "orders": "Orders",
    "notes": "Notes",
    "managementPanel": "Admin",
    "upgradeSubscription": "Upgrade",
    "visualizationTitle": "Chart",
    "recordsTitle": "Records",
    "colTimestamp": "Date",
    "colDM": "DM",
    "colAdSpend": "Ads",
    "colSales": "Sales",
    "colRevenue": "Rev",
    "colNetProfit": "Profit",
    "colActions": "Action",
    "delete": "Del",
    "subModalTitle": "Subscription Plans",
    "subPrice1": "1 Month: ${price}",
    "subPrice3": "3 Months: ${price}",
    "subPrice12": "1 Year: ${price}",
    "subAdminEdit": "Edit Prices (Admin)",
    "notesTitle": "Notepad",
    "addNote": "Add New Note",
    "noteTitlePh": "Title...",
    "noteBodyPh": "Content...",
    "noteFile": "Select File",
    "noteDate": "Reminder Date",
    "saveNote": "Save Note",
    "ordersTitle": "Order Tracking",
    "orderName": "Customer Name",
    "orderReq": "Request",
    "orderAmt": "Amount",
    "orderNote": "Note",
    "orderReason": "Reason",
    "orderDate": "Due Date / Reminder",
    "saveOrder": "Add Order",
    "addToMetrics": "Add to Metrics",
    "addToMetricsConfirm": "Add order (${amount}$) to revenue?",
    "alertExpired": "Expired Reminders!",
    "alertExpiredBody": "Items due:",
    "extendTime": "Extend",
    "dismiss": "Dismiss",
    "viewCredentials": "Account Info",
    "accountSwitch": "Quick Switch",
    "logout": "Logout",
    "language": "Language",
    "theme": "Theme",
    "accountInfoTitle": "Account Info",
    "accountInfoBody": "<p><strong>Email:</strong> {email}</p><p><strong>Pass:</strong> {password}</p><p><strong>Plan:</strong> <span class='{subClass} font-bold'>{subText}</span></p>",
    "subFree": "Free",
    "subDiamond": "Diamond",
    "noDataYet": "No data yet.",
    "noRecordsFound": "No records found.",
    "errorFreeLimitTitle": "Limit Reached",
    "errorFreeLimitBody": "Free limit ({limit}) reached. Please upgrade.",
    "switchAccountLabel": "Quick Switch Accounts:",
    "deleteFromList": "Remove",
    "quickLoginDeleteTitle": "Remove from Quick Login",
    "quickLoginDeleteBody": "Remove this account from quick login list?",
    "deleteRecordTitle": "Delete Record",
    "deleteRecordBody": "Delete this metric record?",
    "errorMinOneMetric": "Enter at least one value.",
    "errorNegativeMetrics": "No negative values.",
    "adminPriceSettings": "Subscription Price Settings",
    "adminPriceSave": "Save Prices",
    "adminPriceSaved": "Prices updated successfully!",
    "userRoleAdmin": "Admin",
    "userRoleUser": "User",
    "actionMakeAdmin": "Make Admin",
    "actionRemoveAdmin": "Revoke Admin",
    "confirmMakeAdmin": "Are you sure you want to grant FULL ADMIN rights to this user?",
    "confirmRemoveAdmin": "Are you sure you want to revoke admin rights?",
  }
};

const translate = (key, vars = {}) => {
  let t = i18n[currentLang][key] || key;
  for (const [k, v] of Object.entries(vars)) t = t.replace(`{${k}}`, v);
  return t;
};

function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('lang', lang);
  document.getElementById('html-tag').lang = currentLang;
  // Animasyonlu geÃ§iÅŸ
  document.body.style.opacity = '0';
  setTimeout(() => { render(); document.body.style.opacity = '1'; }, 200);
}

/* --- Uygulama DeÄŸiÅŸkenleri --- */
const root = document.getElementById('app-root');
let currentUser = localStorage.getItem('current_user') || null;
let currentView = 'dashboard'; 
let currentTheme = localStorage.getItem('theme_mode') || 'light';

/* --- Ayarlar ve FiyatlandÄ±rma --- */
const loadConfig = () => JSON.parse(localStorage.getItem('app_config') || '{"prices":{"p1":3,"p3":7,"p12":30}}');
const saveConfig = (cfg) => localStorage.setItem('app_config', JSON.stringify(cfg));

/* --- Tema MantÄ±ÄŸÄ± (Gece/GÃ¼ndÃ¼z) --- */
function setThemeMode(mode) {
    currentTheme = mode;
    localStorage.setItem('theme_mode', mode);
    if (mode === 'dark') document.body.classList.add('dark');
    else document.body.classList.remove('dark');
    // Ä°konu gÃ¼ncelle
    const btn = document.getElementById('theme-toggle-btn');
    if(btn) updateThemeButton(btn);
}

function updateThemeButton(btn) {
    if(currentTheme === 'light') {
        btn.innerHTML = `<span class="flex items-center"><i data-lucide="sun" class="w-4 h-4 mr-2 text-yellow-500"></i> GÃ¼ndÃ¼z</span>`;
    } else {
        btn.innerHTML = `<span class="flex items-center"><i data-lucide="moon" class="w-4 h-4 mr-2 text-blue-500"></i> Gece</span>`;
    }
    lucide.createIcons();
}

function toggleTheme() {
    setThemeMode(currentTheme === 'light' ? 'dark' : 'light');
}
setThemeMode(currentTheme); // BaÅŸlangÄ±Ã§ta uygula

/* --- Depolama ve YardÄ±mcÄ±lar --- */
const safeKeyFromEmail = (email) => 'dashboard_data_' + encodeURIComponent(email.toLowerCase());
const generateId = () => Date.now().toString(36) + Math.random().toString(36).slice(2);
const loadAllUsers = () => JSON.parse(localStorage.getItem('users_extended') || '{}');
const saveAllUsers = (users) => localStorage.setItem('users_extended', JSON.stringify(users));

// HÄ±zlÄ± GiriÅŸ Depolama
const loadQuickLoginAccounts = () => JSON.parse(localStorage.getItem('quick_login_accounts') || '[]');
const saveQuickLoginAccounts = (arr) => localStorage.setItem('quick_login_accounts', JSON.stringify([...new Set(arr)]));

function addToQuickLogin(email) {
    let accs = loadQuickLoginAccounts();
    if(!accs.includes(email)) { accs.push(email); saveQuickLoginAccounts(accs); }
}
function removeFromQuickLogin(email) {
    let accs = loadQuickLoginAccounts();
    saveQuickLoginAccounts(accs.filter(a => a !== email));
}

/* --- KullanÄ±cÄ± BaÅŸlatma --- */
function initializeUsers() {
    let users = loadAllUsers();
    let updated = false;
    const now = Date.now();

    const adminUser = users[ADMIN_EMAIL];
    if (!adminUser || adminUser.password !== ADMIN_PASSWORD || !adminUser.isAdmin || adminUser.subscription !== 'diamond') {
        users[ADMIN_EMAIL] = { password: ADMIN_PASSWORD, isAdmin: true, isBanned: false, createdAt_ms: now, subscription: 'diamond' };
        updated = true;
    }
    if (updated) saveAllUsers(users);
    return users;
}

/* --- Render MantÄ±ÄŸÄ± --- */
function showCustomModal(title, content, isConfirm = false, onConfirm, onCancel, options = {}) {
    const backdrop = document.getElementById('custom-modal-backdrop');
    const modal = document.getElementById('custom-modal');
    
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-content').innerHTML = content;
    
    const confirmBtn = document.getElementById('modal-confirm-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');
    const modalActions = document.getElementById('modal-actions');
    
    confirmBtn.onclick = null; cancelBtn.onclick = null;
    
    const hide = () => {
        modal.classList.remove('scale-100', 'opacity-100');
        modal.classList.add('scale-95', 'opacity-0');
        setTimeout(() => backdrop.classList.add('hidden'), 300);
    };
    
    if (options.hideActions) modalActions.classList.add('hidden'); else modalActions.classList.remove('hidden');
    if (isConfirm) {
        confirmBtn.classList.remove('hidden');
        confirmBtn.textContent = options.confirmText || 'Onayla';
        cancelBtn.textContent = options.cancelText || 'Ä°ptal';
        confirmBtn.onclick = () => { hide(); if (onConfirm) onConfirm(); };
        cancelBtn.onclick = () => { hide(); if (onCancel) onCancel(); };
    } else {
        confirmBtn.classList.add('hidden');
        cancelBtn.textContent = 'Tamam';
        cancelBtn.onclick = hide;
    }
    
    backdrop.classList.remove('hidden');
    // Animasyon
    requestAnimationFrame(() => {
        modal.classList.remove('scale-95', 'opacity-0');
        modal.classList.add('scale-100', 'opacity-100');
    });
}

function render() {
    initializeUsers(); 
    setThemeMode(localStorage.getItem('theme_mode') || 'light');
    
    // Ä°Ã§erik konteynerini sÄ±fÄ±rla ve animasyon ekle
    root.innerHTML = ''; 
    const container = document.createElement('div');
    container.className = 'fade-in-up w-full';
    root.appendChild(container);
    
    const renderTarget = container; // Render fonksiyonlarÄ± buraya yazacak

    if (!currentUser) renderLogin(renderTarget);
    else if (currentView === 'management') renderManagementPanel(renderTarget);
    else if (currentView === 'notes') renderNotesPanel(renderTarget);
    else if (currentView === 'orders') renderOrdersPanel(renderTarget);
    else renderDashboard(renderTarget);
    
    lucide.createIcons();
}

/* --- HatÄ±rlatÄ±cÄ± KontrolÃ¼ --- */
function checkReminders() {
    if (!currentUser) return;
    const notesKey = 'notes_list_' + encodeURIComponent(currentUser);
    const ordersKey = 'orders_data_' + encodeURIComponent(currentUser);
    const notes = JSON.parse(localStorage.getItem(notesKey) || '[]');
    const orders = JSON.parse(localStorage.getItem(ordersKey) || '[]');
    const now = Date.now();
    let expiredItems = [];

    notes.forEach(n => { if(n.reminderTime && new Date(n.reminderTime).getTime() < now && !n.alerted) expiredItems.push({type: 'Not', ...n}); });
    orders.forEach(o => { if(o.reminderTime && new Date(o.reminderTime).getTime() < now && !o.alerted) expiredItems.push({type: 'SipariÅŸ', ...o}); });

    if (expiredItems.length > 0) {
        let html = `<p class="mb-2">${translate('alertExpiredBody')}</p><ul class="list-disc pl-5 text-red-600 font-bold">`;
        expiredItems.forEach(i => html += `<li>${i.type}: ${i.title || i.name}</li>`);
        html += `</ul>`;
        showCustomModal(translate('alertExpired'), html, false);
    }
}

/* --- HÄ±zlÄ± GeÃ§iÅŸ ModalÄ± --- */
function renderAccountSwitchModal() {
    const accs = loadQuickLoginAccounts();
    let html = `<h3 class="font-bold mb-2 dark:text-white">${translate('switchAccountLabel')}</h3>
    <div class="space-y-2 max-h-60 overflow-y-auto">`;
    
    accs.forEach(email => {
        html += `
        <div class="flex items-center justify-between bg-gray-50 dark:bg-stone-700 p-3 rounded border dark:border-stone-600">
            <button onclick="doQuickLogin('${email}')" class="text-left flex-grow font-medium dark:text-white">${email}</button>
            <button onclick="delQuickLogin('${email}')" class="text-red-500 hover:text-red-700 ml-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
        </div>`;
    });
    html += `</div>`;
    
    showCustomModal(translate('accountSwitch'), html, false, null, null, {cancelText: translate('close')});
    lucide.createIcons();
    
    window.doQuickLogin = (email) => {
        localStorage.setItem('current_user', email); currentUser = email; 
        document.getElementById('custom-modal-backdrop').classList.add('hidden');
        render();
    };
    window.delQuickLogin = (email) => {
        if(confirm(translate('quickLoginDeleteBody'))) {
            removeFromQuickLogin(email);
            renderAccountSwitchModal();
        }
    };
}

/* --- Abonelik ModalÄ± --- */
function renderSubscriptionModal() {
    const cfg = loadConfig();
    const users = loadAllUsers();
    const isAdmin = (users[currentUser] || {}).isAdmin;
    
    const modalContent = `
        <div class="space-y-4">
            <div class="p-4 border rounded-lg bg-white dark:bg-stone-700 shadow-sm">
                <h4 class="font-bold text-lg dark:text-white text-brand-green mb-2">AylÄ±k Paketler</h4>
                <ul class="list-disc pl-5 text-sm dark:text-gray-300 space-y-1">
                    <li>${translate('subPrice1', {price: '$'+cfg.prices.p1})}</li>
                    <li>${translate('subPrice3', {price: '$'+cfg.prices.p3})}</li>
                    <li>${translate('subPrice12', {price: '$'+cfg.prices.p12})}</li>
                </ul>
                <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">Avantajlar: SÄ±nÄ±rsÄ±z KayÄ±t, GeliÅŸmiÅŸ Notlar, Dosya YÃ¼kleme</div>
                <a href="https://wa.me/994707841414" target="_blank" class="block mt-3 bg-green-600 text-white text-center py-2 rounded font-bold hover:bg-green-700 transition">WhatsApp ile SatÄ±n Al</a>
            </div>
            
            ${isAdmin ? `
            <div class="p-4 border border-yellow-500 rounded-lg bg-yellow-50 dark:bg-stone-800 mt-4">
                <h5 class="font-bold text-yellow-700 dark:text-yellow-500 mb-2">${translate('subAdminEdit')}</h5>
                <div class="grid grid-cols-3 gap-2">
                    <input id="p1" type="number" value="${cfg.prices.p1}" class="p-1 border rounded text-sm dark:bg-stone-700 dark:text-white">
                    <input id="p3" type="number" value="${cfg.prices.p3}" class="p-1 border rounded text-sm dark:bg-stone-700 dark:text-white">
                    <input id="p12" type="number" value="${cfg.prices.p12}" class="p-1 border rounded text-sm dark:bg-stone-700 dark:text-white">
                </div>
                <button id="save-prices-btn" class="mt-2 bg-yellow-600 text-white px-3 py-1 rounded text-xs hover:bg-yellow-700">FiyatlarÄ± Kaydet</button>
            </div>` : ''}
        </div>
    `;
    
    showCustomModal(translate('subModalTitle'), modalContent, false, null, null, { cancelText: translate('close') });
    
    if(isAdmin) {
        document.getElementById('save-prices-btn').onclick = () => {
            cfg.prices.p1 = document.getElementById('p1').value;
            cfg.prices.p3 = document.getElementById('p3').value;
            cfg.prices.p12 = document.getElementById('p12').value;
            saveConfig(cfg);
            showCustomModal('BaÅŸarÄ±lÄ±', translate('adminPriceSaved'), false);
        };
    }
}

/* --- Login EkranÄ± --- */
function renderLogin(target) {
    target.innerHTML = `
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md bg-white/90 dark:bg-stone-800/90 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-gray-200 dark:border-stone-700 relative z-10">
            <div class="flex justify-center mb-4"><img src="logo.jpg" class="h-16 w-auto rounded-xl shadow-lg" onerror="this.style.display='none'"></div>
            <h2 class="text-3xl font-bold text-center text-brand-green dark:text-green-400 mb-6">${translate('loginTitle')}</h2>
            
            <div class="mb-4 p-3 text-xs bg-gray-100 dark:bg-stone-900 dark:text-gray-300 rounded border h-24 overflow-y-auto">
                <strong>${translate('rulesTitle')}:</strong><br>${translate('rulesContent')}
            </div>

            <form id="login-form" class="space-y-4">
                <input id="login-email" type="email" placeholder="${translate('emailPlaceholder')}" class="w-full px-5 py-3 rounded-xl bg-white dark:bg-stone-700 border dark:border-stone-600 dark:text-white outline-none focus:ring-2 focus:ring-green-500" required>
                <input id="login-password" type="password" placeholder="${translate('passwordPlaceholder')}" class="w-full px-5 py-3 rounded-xl bg-white dark:bg-stone-700 border dark:border-stone-600 dark:text-white outline-none focus:ring-2 focus:ring-green-500" required>
                
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="terms-check" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <label for="terms-check" class="text-sm text-gray-700 dark:text-gray-300 cursor-pointer">${translate('termsLabel')}</label>
                </div>

                <button type="submit" class="w-full py-3 bg-brand-green hover:bg-green-700 text-white font-bold rounded-xl transition shadow-lg">${translate('loginButton')}</button>
            </form>
            
            <div class="flex justify-between mt-4 text-sm px-2">
                <button id="toggle-register" class="text-green-600 font-bold hover:underline">${translate('registerNow')}</button>
                <button id="quick-switch-btn" class="text-blue-500 font-bold hover:underline">${translate('accountSwitch')}</button>
            </div>

            <div class="text-center mt-6 pt-4 border-t border-gray-200 dark:border-stone-600 flex justify-center items-center space-x-4 text-sm">
                <button onclick="setLanguage('tr')" class="${currentLang==='tr'?'font-bold text-green-600 dark:text-green-400':''}">TR</button>
                <button onclick="setLanguage('en')" class="${currentLang==='en'?'font-bold text-green-600 dark:text-green-400':''}">EN</button>
                <button id="theme-toggle-btn-login" class="ml-4"></button>
            </div>
        </div>
    </div>`;

    updateThemeButton(document.getElementById('theme-toggle-btn-login'));
    document.getElementById('theme-toggle-btn-login').onclick = () => { toggleTheme(); render(); };

    const form = document.getElementById('login-form');
    let isRegister = false;

    document.getElementById('toggle-register').onclick = (e) => {
        e.preventDefault(); isRegister = !isRegister;
        form.querySelector('button').textContent = isRegister ? translate('registerButton') : translate('loginButton');
    };
    
    document.getElementById('quick-switch-btn').onclick = renderAccountSwitchModal;

    form.onsubmit = (e) => {
        e.preventDefault();
        if (!document.getElementById('terms-check').checked) { showCustomModal('!', translate('termsError')); return; }
        
        const email = document.getElementById('login-email').value.trim().toLowerCase();
        const password = document.getElementById('login-password').value;
        const users = loadAllUsers();

        if (isRegister) {
            if (users[email]) return showCustomModal('!', translate('errorMailInUse'));
            users[email] = { password, isAdmin: false, subscription: 'none', createdAt_ms: Date.now() };
            saveAllUsers(users);
            addToQuickLogin(email);
            localStorage.setItem('current_user', email); currentUser = email; render();
        } else {
            if (users[email] && users[email].password === password) {
                if(users[email].isBanned) return showCustomModal('!', translate('errorBanned', {email}));
                addToQuickLogin(email);
                localStorage.setItem('current_user', email); currentUser = email; render();
            } else {
                showCustomModal('!', translate('errorWrongCreds'));
            }
        }
    };
}

/* --- Not Paneli --- */
function renderNotesPanel(target) {
    const key = 'notes_list_' + encodeURIComponent(currentUser);
    let notes = JSON.parse(localStorage.getItem(key) || '[]');

    const handleAddNote = () => {
        const title = document.getElementById('n-title').value;
        const body = document.getElementById('n-body').value;
        const date = document.getElementById('n-date').value;
        const fileInput = document.getElementById('n-file');
        
        if(!title) return alert('BaÅŸlÄ±k gerekli');

        const save = (fileData) => {
            notes.push({ id: generateId(), title, body, reminderTime: date, file: fileData, alerted: false });
            localStorage.setItem(key, JSON.stringify(notes));
            renderNotesPanel(target);
        };

        if(fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => save(e.target.result);
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            save(null);
        }
    };

    window.delNote = (id) => {
        notes = notes.filter(n => n.id !== id);
        localStorage.setItem(key, JSON.stringify(notes));
        renderNotesPanel(target);
    };

    let listHtml = notes.map(n => `
        <div class="bg-white dark:bg-stone-700 p-4 rounded shadow mb-4 border border-gray-200 dark:border-stone-600 relative">
            <div class="flex justify-between">
                <h4 class="font-bold text-lg dark:text-white">${n.title}</h4>
                <button onclick="window.delNote('${n.id}')" class="text-red-500"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
            </div>
            <p class="text-gray-600 dark:text-gray-300 text-sm mt-1 whitespace-pre-wrap">${n.body}</p>
            ${n.file ? `<img src="${n.file}" class="mt-3 max-h-40 rounded border">` : ''}
            ${n.reminderTime ? `<div class="mt-2 text-xs text-blue-600 dark:text-blue-400 font-bold flex items-center"><i data-lucide="clock" class="h-3 w-3 mr-1"></i> ${new Date(n.reminderTime).toLocaleString()}</div>` : ''}
        </div>
    `).reverse().join('');

    target.innerHTML = `
        <div class="min-h-screen p-4 md:p-8 relative z-10">
            <div class="flex justify-between mb-6 items-center bg-white/80 dark:bg-stone-800/80 p-4 rounded-xl shadow backdrop-blur">
                <h1 class="text-3xl font-bold text-blue-600 flex items-center"><i data-lucide="notebook-tabs" class="mr-2"></i>${translate('notesTitle')}</h1>
                <button id="back-dash" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-medium">Geri</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-white/90 dark:bg-stone-800/90 p-5 rounded-xl border dark:border-stone-700 shadow-lg h-fit backdrop-blur">
                    <h3 class="font-bold mb-3 dark:text-white border-b pb-2">${translate('addNote')}</h3>
                    <input id="n-title" class="w-full mb-2 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white" placeholder="${translate('noteTitlePh')}">
                    <textarea id="n-body" class="w-full mb-2 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white h-32" placeholder="${translate('noteBodyPh')}"></textarea>
                    <div class="mb-2">
                        <label class="text-xs dark:text-gray-400 block mb-1">${translate('noteFile')}</label>
                        <input type="file" id="n-file" class="w-full text-sm dark:text-gray-300">
                    </div>
                    <label class="text-xs dark:text-gray-400 block mb-1">${translate('noteDate')}</label>
                    <input type="datetime-local" id="n-date" class="w-full mb-4 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white">
                    <button id="add-n-btn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">${translate('saveNote')}</button>
                </div>
                <div class="lg:col-span-2">
                    ${listHtml || '<p class="text-center opacity-50 dark:text-white">HenÃ¼z not yok.</p>'}
                </div>
            </div>
        </div>
    `;
    
    lucide.createIcons();
    document.getElementById('back-dash').onclick = () => { currentView = 'dashboard'; render(); };
    document.getElementById('add-n-btn').onclick = handleAddNote;
}

/* --- SipariÅŸ Paneli --- */
function renderOrdersPanel(target) {
    const key = 'orders_data_' + encodeURIComponent(currentUser);
    let orders = JSON.parse(localStorage.getItem(key) || '[]');

    const handleSave = () => {
        const name = document.getElementById('o-name').value;
        const req = document.getElementById('o-req').value;
        const amt = document.getElementById('o-amt').value;
        const note = document.getElementById('o-note').value;
        const date = document.getElementById('o-date').value;
        
        if(!name) return alert('Ä°sim gerekli');
        orders.push({ id: generateId(), name, req, amount: amt, note, reminderTime: date, createdAt: Date.now(), alerted: false });
        localStorage.setItem(key, JSON.stringify(orders));
        renderOrdersPanel(target);
    };

    window.delOrd = (id) => {
        orders = orders.filter(o => o.id !== id);
        localStorage.setItem(key, JSON.stringify(orders));
        renderOrdersPanel(target);
    };

    window.addToMet = (id) => {
        const order = orders.find(o => o.id === id);
        if(!order) return;
        
        showCustomModal('Onay', translate('addToMetricsConfirm', {amount: order.amount}), true, () => {
            const metricKey = 'dashboard_data_' + encodeURIComponent(currentUser.toLowerCase());
            let metrics = JSON.parse(localStorage.getItem(metricKey) || '[]');
            metrics.push({ 
                id: generateId(), 
                dmCount: 0, adSpend: 0, salesCount: 1, 
                revenue: parseFloat(order.amount) || 0, 
                createdAt_ms: Date.now() 
            });
            localStorage.setItem(metricKey, JSON.stringify(metrics));
            alert('Gelir olarak eklendi!');
        });
    };

    let listHtml = orders.map(o => `
        <div class="bg-white dark:bg-stone-700 p-4 rounded shadow mb-3 border border-purple-200 dark:border-stone-600 relative">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-lg dark:text-white">${o.name}</h4>
                    <div class="text-xs text-gray-500">${new Date(o.createdAt).toLocaleDateString()}</div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.addToMet('${o.id}')" class="text-green-600 hover:text-green-800 p-1 bg-green-100 rounded" title="${translate('addToMetrics')}"><i data-lucide="bar-chart-big" class="h-5 w-5"></i></button>
                    <button onclick="window.delOrd('${o.id}')" class="text-red-500 hover:text-red-700 p-1 bg-red-100 rounded"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2 text-sm dark:text-gray-200">
                <p><strong>Ä°stek:</strong> ${o.req}</p>
                <p><strong>Tutar:</strong> ${o.amount}$</p>
                <p class="col-span-2"><strong>Not:</strong> ${o.note}</p>
                ${o.reminderTime ? `<p class="col-span-2 text-red-500 font-bold flex items-center"><i data-lucide="clock" class="h-3 w-3 mr-1"></i> ${new Date(o.reminderTime).toLocaleString()}</p>` : ''}
            </div>
        </div>
    `).reverse().join('');

    target.innerHTML = `
        <div class="min-h-screen p-4 md:p-8 relative z-10">
            <div class="flex justify-between mb-6 items-center bg-white/80 dark:bg-stone-800/80 p-4 rounded-xl shadow backdrop-blur">
                <h1 class="text-3xl font-bold text-purple-600 flex items-center"><i data-lucide="shopping-cart" class="mr-2"></i>${translate('ordersTitle')}</h1>
                <button id="back-dash" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-medium">Geri</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-white/90 dark:bg-stone-800/90 p-5 rounded-xl border dark:border-stone-700 shadow-lg h-fit backdrop-blur">
                    <input id="o-name" class="w-full mb-2 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white" placeholder="${translate('orderName')}">
                    <input id="o-req" class="w-full mb-2 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white" placeholder="${translate('orderReq')}">
                    <input id="o-amt" type="number" class="w-full mb-2 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white" placeholder="${translate('orderAmt')}">
                    <textarea id="o-note" class="w-full mb-2 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white" placeholder="${translate('orderNote')}"></textarea>
                    <label class="text-xs dark:text-gray-400 block mb-1">${translate('orderDate')}</label>
                    <input type="datetime-local" id="o-date" class="w-full mb-4 p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white">
                    <button id="add-o-btn" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 font-bold shadow">${translate('saveOrder')}</button>
                </div>
                <div class="lg:col-span-2">
                    ${listHtml || '<p class="text-center opacity-50 dark:text-white">SipariÅŸ yok.</p>'}
                </div>
            </div>
        </div>
    `;
    
    lucide.createIcons();
    document.getElementById('back-dash').onclick = () => { currentView = 'dashboard'; render(); };
    document.getElementById('add-o-btn').onclick = handleSave;
}

/* --- Ana Dashboard --- */
function renderDashboard(target) {
    const users = loadAllUsers();
    const u = users[currentUser] || {};
    const sub = u.subscription || 'none';
    const isAdmin = u.isAdmin;

    target.innerHTML = `
        <div class="min-h-screen p-4 md:p-8 relative z-10">
            <!-- BaÅŸlÄ±k: z-50 ile her ÅŸeyin Ã¼stÃ¼nde -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white/80 dark:bg-stone-800/80 backdrop-blur p-4 rounded-2xl shadow-xl border border-white/20 dark:border-stone-700 relative z-50">
                <div class="flex items-center space-x-3">
                    <img src="logo.jpg" class="h-10 w-auto rounded" onerror="this.style.display='none'">
                    <h1 class="text-3xl font-extrabold text-green-800 dark:text-green-400 tracking-tight">${translate('dashboardTitle')}</h1>
                </div>
                <div class="flex flex-wrap justify-center gap-3 mt-4 md:mt-0 items-center">
                    ${(sub === 'diamond' || isAdmin) ? `
                        <button onclick="currentView='orders';render()" class="bg-purple-500 text-white px-3 py-2 rounded-lg shadow hover:bg-purple-600 flex items-center transition"><i data-lucide="shopping-cart" class="w-4 h-4 mr-2"></i> ${translate('orders')}</button>
                        <button onclick="currentView='notes';render()" class="bg-blue-500 text-white px-3 py-2 rounded-lg shadow hover:bg-blue-600 flex items-center transition"><i data-lucide="notebook-tabs" class="w-4 h-4 mr-2"></i> ${translate('notes')}</button>
                    ` : ''}
                    
                    ${isAdmin ? `<button onclick="currentView='management';render()" class="bg-yellow-500 text-white px-3 py-2 rounded-lg shadow hover:bg-yellow-600 flex items-center transition"><i data-lucide="shield" class="w-4 h-4 mr-2"></i> Admin</button>` : ''}
                    
                    ${(sub === 'none' && !isAdmin) ? `<button onclick="renderSubscriptionModal()" class="bg-yellow-500 text-white px-3 py-2 rounded-lg shadow hover:bg-yellow-600 flex items-center transition animate-pulse"><i data-lucide="gem" class="w-4 h-4 mr-2"></i> ${translate('upgradeSubscription')}</button>` : ''}
                    
                    <!-- Profil Dropdown -->
                    <div class="relative inline-block text-left">
                        <button id="profile-btn" class="bg-brand-green hover:bg-brand-green-dark text-white px-4 py-2 rounded-lg shadow flex items-center">
                            <i data-lucide="user" class="w-4 h-4 mr-2"></i> HesabÄ±m
                        </button>
                        <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-stone-800 rounded-md shadow-lg py-1 z-50 ring-1 ring-black ring-opacity-5">
                             <button onclick="showCredentials()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-stone-700 w-full text-left flex items-center"><i data-lucide="info" class="w-4 h-4 mr-2"></i> ${translate('viewCredentials')}</button>
                             <button onclick="renderAccountSwitchModal()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-stone-700 w-full text-left flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i> ${translate('accountSwitch')}</button>
                             <button id="theme-toggle-btn-dash" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-stone-700 w-full text-left">Tema</button>
                             
                             <!-- Dil SeÃ§enekleri -->
                             <div class="border-t border-gray-100 dark:border-stone-700 my-1"></div>
                             <button onclick="setLanguage('tr')" class="block px-4 py-2 text-sm ${currentLang==='tr'?'text-green-600 font-bold':'text-gray-700 dark:text-gray-200'} hover:bg-gray-100 dark:hover:bg-stone-700 w-full text-left">ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e</button>
                             <button onclick="setLanguage('en')" class="block px-4 py-2 text-sm ${currentLang==='en'?'text-green-600 font-bold':'text-gray-700 dark:text-gray-200'} hover:bg-gray-100 dark:hover:bg-stone-700 w-full text-left">ðŸ‡ºðŸ‡¸ English</button>

                             <div class="border-t border-gray-100 dark:border-stone-700 my-1"></div>
                             <button onclick="logout()" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-stone-700 w-full text-left flex items-center"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i> ${translate('logout')}</button>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 relative z-0">
                <!-- Veri GiriÅŸi -->
                <section class="bg-white/90 dark:bg-stone-800/90 backdrop-blur p-6 rounded-2xl shadow-xl border border-white/20 dark:border-stone-700">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">${translate('dailyEntryTitle')}</h2>
                    <form id="add-data-form" class="space-y-3">
                        <input id="dmCount" type="number" placeholder="${translate('dmCountLabel')}" class="w-full p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white focus:ring-2 focus:ring-green-500 outline-none">
                        <input id="adSpend" type="number" step="0.01" placeholder="${translate('adSpendLabel')}" class="w-full p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white focus:ring-2 focus:ring-green-500 outline-none">
                        <input id="salesCount" type="number" placeholder="${translate('salesCountLabel')}" class="w-full p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white focus:ring-2 focus:ring-green-500 outline-none">
                        <input id="revenue" type="number" step="0.01" placeholder="${translate('revenueLabel')}" class="w-full p-2 rounded border dark:bg-stone-700 dark:border-stone-600 dark:text-white focus:ring-2 focus:ring-green-500 outline-none">
                        <button type="submit" class="w-full bg-brand-green text-white py-2 rounded hover:bg-green-700 font-bold shadow transition transform hover:scale-[1.02]">${translate('saveMetricsButton')}</button>
                    </form>
                </section>
                <!-- Grafik -->
                <section class="lg:col-span-2 bg-white/90 dark:bg-stone-800/90 backdrop-blur p-6 rounded-2xl shadow-xl border border-white/20 dark:border-stone-700">
                    <div id="chart-area" class="w-full h-64"></div>
                </section>
            </div>

            <!-- Tablo -->
            <section class="bg-white/90 dark:bg-stone-800/90 backdrop-blur p-6 rounded-2xl shadow-xl border border-white/20 dark:border-stone-700">
                <h2 class="text-xl font-bold mb-4 dark:text-white">${translate('recordsTitle')}</h2>
                <div id="table-area" class="overflow-x-auto"></div>
            </section>
        </div>
    `;

    lucide.createIcons();
    checkReminders(); 
    
    // Profil Dropdown Logic
    const pBtn = document.getElementById('profile-btn');
    const pDrop = document.getElementById('profile-dropdown');
    if(pBtn) {
        pBtn.onclick = (e) => { e.stopPropagation(); pDrop.classList.toggle('hidden'); };
        document.onclick = () => pDrop.classList.add('hidden');
        pDrop.onclick = (e) => e.stopPropagation();
    }

    // Tema butonu dashboard iÃ§inde
    const themeBtnDash = document.getElementById('theme-toggle-btn-dash');
    if(themeBtnDash) {
        updateThemeButton(themeBtnDash);
        themeBtnDash.onclick = () => { toggleTheme(); updateThemeButton(themeBtnDash); };
    }

    window.logout = () => { localStorage.removeItem('current_user'); currentUser = null; render(); };
    window.showCredentials = () => {
         let subText = u.subscription === 'diamond' ? translate('subDiamond') : translate('subFree');
         if (u.isAdmin) subText = `Admin (${subText})`;
         showCustomModal(translate('accountInfoTitle'), translate('accountInfoBody', { email: currentUser, password: u.password, subText, subClass: 'text-yellow-600' }), false);
    };

    // Metrik Verileri
    const key = 'dashboard_data_' + encodeURIComponent(currentUser.toLowerCase());
    const data = JSON.parse(localStorage.getItem(key) || '[]');
    
    // Grafik
    if(data.length) {
        const ctx = document.createElement('canvas');
        document.getElementById('chart-area').innerHTML = '';
        document.getElementById('chart-area').appendChild(ctx);
        
        const totalDm = data.reduce((s,i) => s + (Number(i.dmCount)||0), 0);
        const totalAd = data.reduce((s,i) => s + (Number(i.adSpend)||0), 0);
        const totalSales = data.reduce((s,i) => s + (Number(i.salesCount)||0), 0);
        const totalRev = data.reduce((s,i) => s + (Number(i.revenue)||0), 0);
        const net = totalRev - totalAd;

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['DM', 'Reklam', 'SatÄ±ÅŸ', 'Gelir', 'Net KÃ¢r'],
                datasets: [{
                    label: 'Toplam',
                    data: [totalDm, totalAd, totalSales, totalRev, net],
                    backgroundColor: ['#0ea5e9', '#ef4444', '#0ea5e9', '#eab308', net>=0?'#22c55e':'#ef4444']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } else {
        document.getElementById('chart-area').innerHTML = '<p class="text-center text-gray-500 py-10 dark:text-gray-400">Veri Yok</p>';
    }

    // Tablo
    const tbody = data.map(d => `
        <tr class="border-b dark:border-stone-600 hover:bg-gray-50 dark:hover:bg-stone-700">
            <td class="p-3 dark:text-white text-sm">${new Date(d.createdAt_ms).toLocaleDateString()}</td>
            <td class="p-3 dark:text-white text-sm">${d.dmCount}</td>
            <td class="p-3 dark:text-white text-sm">${d.adSpend}$</td>
            <td class="p-3 dark:text-white text-sm">${d.salesCount}</td>
            <td class="p-3 dark:text-white text-sm">${d.revenue}$</td>
            <td class="p-3 font-bold text-sm ${(d.revenue-d.adSpend)>=0?'text-green-600':'text-red-600'}">${(d.revenue-d.adSpend).toFixed(2)}$</td>
            <td class="p-3">
                ${(sub === 'diamond' || isAdmin) ? `<button onclick="deleteMetric('${d.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
            </td>
        </tr>
    `).reverse().join('');
    
    document.getElementById('table-area').innerHTML = `
        <table class="w-full text-left">
            <thead class="bg-gray-100 dark:bg-stone-700 text-xs uppercase text-gray-500 dark:text-gray-300">
                <tr><th class="p-3">Tarih</th><th class="p-3">DM</th><th class="p-3">Reklam</th><th class="p-3">SatÄ±ÅŸ</th><th class="p-3">Gelir</th><th class="p-3">KÃ¢r</th><th class="p-3">Ä°ÅŸlem</th></tr>
            </thead>
            <tbody>${tbody || '<tr><td colspan="7" class="p-4 text-center dark:text-gray-400">KayÄ±t yok.</td></tr>'}</tbody>
        </table>
    `;
    lucide.createIcons();

    window.deleteMetric = (id) => {
        const newData = data.filter(d => d.id !== id);
        localStorage.setItem(key, JSON.stringify(newData));
        render();
    };

    document.getElementById('add-data-form').onsubmit = (e) => {
        e.preventDefault();
        // Ãœcretsiz Limit KontrolÃ¼
        if(sub === 'none' && data.length >= FREE_TIER_LIMIT) { 
             showCustomModal(translate('errorFreeLimitTitle'), translate('errorFreeLimitBody', {limit: FREE_TIER_LIMIT}), false); 
             setTimeout(renderSubscriptionModal, 1500);
             return; 
        }
        
        const newItem = {
            id: generateId(),
            dmCount: document.getElementById('dmCount').value || 0,
            adSpend: document.getElementById('adSpend').value || 0,
            salesCount: document.getElementById('salesCount').value || 0,
            revenue: document.getElementById('revenue').value || 0,
            createdAt_ms: Date.now()
        };
        data.push(newItem);
        localStorage.setItem(key, JSON.stringify(data));
        render();
    };
}

/* Admin YÃ¶netim Paneli (YENÄ°: Fiyat ve Yetki YÃ¶netimi) */
function renderManagementPanel(target) {
    const users = loadAllUsers();
    const allUsers = Object.keys(users).map(email => ({ email, ...users[email] })).filter(u => u.email !== ADMIN_EMAIL);
    const cfg = loadConfig();

    target.innerHTML = `
    <div class="min-h-screen p-8 relative z-10">
        <div class="flex justify-between items-center mb-6 bg-white/80 dark:bg-stone-800/80 p-4 rounded-xl shadow backdrop-blur">
             <h2 class="text-2xl font-bold dark:text-white">KullanÄ±cÄ± YÃ¶netimi</h2>
             <button onclick="currentView='dashboard';render()" class="bg-gray-500 text-white px-4 py-2 rounded shadow">Geri</button>
        </div>
        
        <!-- Fiyat AyarlarÄ± -->
        <div class="bg-white dark:bg-stone-800 p-4 rounded shadow mb-6 border dark:border-stone-700">
            <h3 class="font-bold text-brand-green mb-3 dark:text-white">${translate('adminPriceSettings')}</h3>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="text-xs dark:text-gray-400">1 AylÄ±k ($)</label><input id="adm-p1" type="number" value="${cfg.prices.p1}" class="w-full p-2 border rounded dark:bg-stone-700 dark:text-white"></div>
                <div><label class="text-xs dark:text-gray-400">3 AylÄ±k ($)</label><input id="adm-p3" type="number" value="${cfg.prices.p3}" class="w-full p-2 border rounded dark:bg-stone-700 dark:text-white"></div>
                <div><label class="text-xs dark:text-gray-400">1 YÄ±llÄ±k ($)</label><input id="adm-p12" type="number" value="${cfg.prices.p12}" class="w-full p-2 border rounded dark:bg-stone-700 dark:text-white"></div>
            </div>
            <button onclick="savePrices()" class="mt-3 bg-yellow-500 text-white px-4 py-2 rounded shadow hover:bg-yellow-600">${translate('adminPriceSave')}</button>
        </div>
       
        <div class="bg-white dark:bg-stone-800 rounded shadow overflow-x-auto border dark:border-stone-700">
            <table class="w-full text-left">
                <thead class="bg-gray-100 dark:bg-stone-700 text-gray-600 dark:text-gray-300"><tr><th class="p-3">Email</th><th class="p-3">Durum</th><th class="p-3">Yetki</th><th class="p-3">Ä°ÅŸlem</th></tr></thead>
                <tbody class="divide-y dark:divide-stone-600">
                    ${allUsers.map(u => `
                        <tr class="dark:hover:bg-stone-700 hover:bg-gray-50">
                            <td class="p-3 dark:text-white">${u.email}</td>
                            <td class="p-3">${u.isBanned ? '<span class="text-red-500 font-bold">YasaklÄ±</span>' : '<span class="text-green-500 font-bold">Aktif</span>'}</td>
                            <td class="p-3 dark:text-white">
                                ${u.isAdmin ? '<span class="text-blue-500 font-bold">YÃ¶netici</span>' : (u.subscription === 'diamond' ? '<span class="text-yellow-500 font-bold">Elmas</span>' : 'KullanÄ±cÄ±')}
                            </td>
                            <td class="p-3 space-x-2">
                                <button onclick="admAct('${u.email}','ban')" class="text-sm px-2 py-1 border rounded hover:bg-gray-100 dark:hover:bg-stone-600 dark:text-white">Ban</button>
                                <button onclick="admAct('${u.email}','sub')" class="text-sm px-2 py-1 border rounded hover:bg-gray-100 dark:hover:bg-stone-600 text-yellow-600 font-bold">Elmas</button>
                                <button onclick="admAct('${u.email}','admin')" class="text-sm px-2 py-1 border rounded hover:bg-gray-100 dark:hover:bg-stone-600 text-blue-600 font-bold">${u.isAdmin ? translate('actionRemoveAdmin') : translate('actionMakeAdmin')}</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
    
    window.savePrices = () => {
        cfg.prices.p1 = document.getElementById('adm-p1').value;
        cfg.prices.p3 = document.getElementById('adm-p3').value;
        cfg.prices.p12 = document.getElementById('adm-p12').value;
        saveConfig(cfg);
        showCustomModal('BaÅŸarÄ±lÄ±', translate('adminPriceSaved'), false);
    };

    window.admAct = (email, type) => {
        if(type === 'ban') users[email].isBanned = !users[email].isBanned;
        if(type === 'sub') users[email].subscription = users[email].subscription === 'diamond' ? 'none' : 'diamond';
        if(type === 'admin') {
             if(!users[email].isAdmin) {
                 // Admin yapma onayÄ±
                 if(!confirm(translate('confirmMakeAdmin'))) return;
                 users[email].isAdmin = true;
                 users[email].subscription = 'diamond'; // Adminler otomatik elmas olur
             } else {
                 if(!confirm(translate('confirmRemoveAdmin'))) return;
                 users[email].isAdmin = false;
             }
        }
        saveAllUsers(users);
        render();
    };
}

// Start
render();

</script>
</body>
</html>
